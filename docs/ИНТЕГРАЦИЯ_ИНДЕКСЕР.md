# Интеграция HyperSniper Bot с HyperSniper Indexer

## Архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         VPS (Debian)                                │
│                                                                     │
│  ┌─────────────────────┐        ┌─────────────────────────────┐    │
│  │  TGTON2Index (Go)   │        │    TGTON2 (Python)          │    │
│  │                     │        │                             │    │
│  │  [Liteserver]       │        │  FastAPI:8000               │    │
│  │       ↓             │ POST   │    /api/indexer/event       │    │
│  │  [Detector]─────────┼───────►│          ↓                  │    │
│  │       ↓             │webhook │    [GemScanner]             │    │
│  │  [Notifier]         │        │          ↓                  │    │
│  │       ↓             │        │    [SafetyChecker]          │    │
│  │  [TG Channel] ◄─────┼────────┼──  [aiogram bot]            │    │
│  └─────────────────────┘        └─────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Redis (общий)                           │   │
│  │  - Кэш минтеров (антидубликация)                           │   │
│  │  - Кэш GemScanner топов                                    │   │
│  │  - Сессии пользователей                                    │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

## Принцип работы

1. **Индексер** сканирует блокчейн TON напрямую через liteserver
2. При обнаружении нового JettonMinter индексер:
   - Выводит в консоль
   - Отправляет в Telegram (если настроен)
   - Отправляет POST запрос на webhook бота
3. **Бот** получает webhook и:
   - Преобразует данные в `JettonMinterEvent`
   - Передаёт в `GemScanner` для обработки
   - GemScanner проверяет через `SafetyChecker`
   - Если токен прошёл фильтры — добавляется в топ

## Формат Webhook

Индексер отправляет POST запрос на `/api/indexer/event`:

```json
{
  "event": "jetton_minter_deployed",
  "minter_address": "EQ...",
  "workchain": 0,
  "seqno": 12345678,
  "tx_hash": "abc123...",
  "tx_lt": 1234567890,
  "code_hash": "hex...",
  "jetton": {
    "name": "Token Name",
    "symbol": "TKN",
    "decimals": 9,
    "total_supply": "1000000000000000000",
    "content_uri": "https://..."
  },
  "admin": {
    "address": "EQ...",
    "is_contract": false
  },
  "flags": {
    "mintable": true,
    "verified_by_interface": true,
    "known_code_hash": true
  },
  "meta": {
    "block_unixtime": 1733900000,
    "indexer_unixtime": 1733900001,
    "latency_ms": 1500,
    "minter_type": "standard"
  },
  "links": {
    "tonviewer": "https://tonviewer.com/...",
    "tonscan": "https://tonscan.org/address/...",
    "dexscreener": "https://dexscreener.com/ton/..."
  }
}
```

## Настройка

### Бот (TGTON2)

В `config/runtime.env`:

```env
# Отключаем WebSocket от toncenter — используем индексер
TON__USE_WEBSOCKET=false

# Redis для общего кэша
CACHE__BACKEND=redis
CACHE__REDIS_DSN=redis://localhost:6379/0
```

### Индексер (TGTON2Index)

В `config.yaml`:

```yaml
notifier:
  webhook_url: "http://localhost:8000/api/indexer/event"

redis:
  addr: "localhost:6379"
```

## Тестирование интеграции

### 1. Проверка endpoint бота

```bash
curl http://localhost:8000/api/indexer/health
```

### 2. Отправка тестового события

```bash
curl -X POST http://localhost:8000/api/indexer/event \
  -H "Content-Type: application/json" \
  -d '{"event":"jetton_minter_deployed","minter_address":"EQTest","jetton":{"symbol":"TEST"}}'
```

### 3. Проверка логов

```bash
# Логи бота
journalctl -u hypersniper-bot -f

# Логи FastAPI
journalctl -u hypersniper-api -f

# Логи индексера
journalctl -u hypersniper-indexer -f
```

## Преимущества интеграции

| Без индексера | С индексером |
|---------------|--------------|
| Задержка 6-8 сек | Задержка 1-3 сек |
| Зависимость от toncenter | Прямое сканирование блокчейна |
| Ограничения API | Полный контроль |
| Пропуски событий | 100% покрытие |

## Fallback режим

Если индексер недоступен, можно включить WebSocket:

```env
TON__USE_WEBSOCKET=true
```

Бот будет получать события от toncenter (медленнее, но работает).

