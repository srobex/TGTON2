# Инструкция по запуску HyperSniper Bot

## Требования

- Python 3.12+
- Redis 7+
- Git

## Быстрый старт на Debian/Ubuntu

### 1. Установка зависимостей системы

```bash
# Обновление системы
sudo apt update && sudo apt upgrade -y

# Установка Python 3.12
sudo apt install python3.12 python3.12-venv python3-pip -y

# Установка Redis
sudo apt install redis-server -y
sudo systemctl enable redis-server
sudo systemctl start redis-server

# Проверка Redis
redis-cli ping  # Должен ответить PONG
```

### 2. Клонирование репозитория

```bash
cd ~
git clone https://github.com/srobex/TGTON2.git
cd TGTON2
```

### 3. Создание виртуального окружения

```bash
python3.12 -m venv .venv
source .venv/bin/activate

# Установка зависимостей
pip install --upgrade pip
pip install -r requirements.txt
```

### 4. Настройка конфигурации

```bash
# Скопируйте шаблон (если используете .env)
# cp .env.example .env

# Или отредактируйте runtime.env
nano config/runtime.env
```

**Обязательные настройки в `config/runtime.env`:**

```env
# Telegram бот
TELEGRAM__TOKEN=ваш_токен_от_BotFather
TELEGRAM__ADMINS=[ваш_telegram_id]

# TON (можно оставить дефолтные публичные)
TON__RPC_ENDPOINT=https://toncenter.com/api/v2/jsonRPC
TON__WS_ENDPOINT=wss://toncenter.com/api/v2/ws
TON__NETWORK=mainnet

# ВАЖНО: отключить WebSocket если используем индексер
TON__USE_WEBSOCKET=false

# Redis (должен совпадать с индексером)
CACHE__BACKEND=redis
CACHE__REDIS_DSN=redis://localhost:6379/0

# Реферальная система
REFERRAL__OMNISTON_PAYLOAD=ваш_payload

# JWT для Mini App
SECURITY__JWT_SECRET=сгенерируйте_случайную_строку_32_символа
```

### 5. Инициализация базы данных

```bash
source .venv/bin/activate
python -m bot.scripts.init_db
```

### 6. Запуск бота

#### Вариант A: Только Telegram бот (polling)

```bash
source .venv/bin/activate
python -m bot.main
```

#### Вариант B: Telegram бот + FastAPI (для webhook от индексера)

```bash
# Терминал 1: Telegram бот
source .venv/bin/activate
python -m bot.main

# Терминал 2: FastAPI для webhook
source .venv/bin/activate
uvicorn bot.web.app:app --host 0.0.0.0 --port 8000
```

#### Вариант C: Запуск как systemd сервис

Создайте файл `/etc/systemd/system/hypersniper-bot.service`:

```ini
[Unit]
Description=HyperSniper Telegram Bot
After=network.target redis.service

[Service]
Type=simple
User=your_user
WorkingDirectory=/home/your_user/TGTON2
Environment=PATH=/home/your_user/TGTON2/.venv/bin
ExecStart=/home/your_user/TGTON2/.venv/bin/python -m bot.main
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Создайте файл `/etc/systemd/system/hypersniper-api.service`:

```ini
[Unit]
Description=HyperSniper FastAPI
After=network.target redis.service

[Service]
Type=simple
User=your_user
WorkingDirectory=/home/your_user/TGTON2
Environment=PATH=/home/your_user/TGTON2/.venv/bin
ExecStart=/home/your_user/TGTON2/.venv/bin/uvicorn bot.web.app:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# Активация сервисов
sudo systemctl daemon-reload
sudo systemctl enable hypersniper-bot hypersniper-api
sudo systemctl start hypersniper-bot hypersniper-api

# Проверка статуса
sudo systemctl status hypersniper-bot
sudo systemctl status hypersniper-api

# Просмотр логов
sudo journalctl -u hypersniper-bot -f
sudo journalctl -u hypersniper-api -f
```

## Проверка работы

### 1. Проверка Telegram бота

Напишите боту `/start` — должен ответить приветствием.

### 2. Проверка FastAPI

```bash
# Проверка health endpoint
curl http://localhost:8000/api/indexer/health

# Должен вернуть:
# {"status":"ok","service":"hypersniper-bot","ready_for_indexer":true}
```

### 3. Тестовый webhook (эмуляция индексера)

```bash
curl -X POST http://localhost:8000/api/indexer/event \
  -H "Content-Type: application/json" \
  -H "X-HyperSniper-Event: jetton_minter_deployed" \
  -d '{
    "event": "jetton_minter_deployed",
    "minter_address": "EQTest123456789",
    "jetton": {
      "name": "Test Token",
      "symbol": "TEST",
      "decimals": 9,
      "total_supply": "1000000000"
    },
    "admin": {
      "address": "EQAdmin123",
      "is_contract": false
    },
    "flags": {
      "mintable": true,
      "verified_by_interface": true,
      "known_code_hash": false
    },
    "meta": {
      "block_unixtime": 1733900000,
      "latency_ms": 1500,
      "minter_type": "standard"
    },
    "links": {
      "tonviewer": "https://tonviewer.com/EQTest123456789",
      "tonscan": "https://tonscan.org/address/EQTest123456789",
      "dexscreener": "https://dexscreener.com/ton/EQTest123456789"
    }
  }'
```

## Интеграция с HyperSniper Indexer

Бот настроен для приёма событий от индексера через webhook.

1. Убедитесь что бот запущен с FastAPI на порту 8000
2. В `TGTON2Index/config.yaml` должен быть указан:
   ```yaml
   notifier:
     webhook_url: "http://localhost:8000/api/indexer/event"
   ```
3. Запустите индексер — он будет отправлять события боту

## Полезные команды

```bash
# Перезапуск бота
sudo systemctl restart hypersniper-bot

# Остановка
sudo systemctl stop hypersniper-bot hypersniper-api

# Логи в реальном времени
sudo journalctl -u hypersniper-bot -f

# Проверка Redis
redis-cli KEYS "*"

# Проверка базы данных
sqlite3 database/hypersniper.db ".tables"
```

## Возможные проблемы

### Бот не отвечает

1. Проверьте токен в `config/runtime.env`
2. Проверьте логи: `journalctl -u hypersniper-bot -f`

### Ошибка подключения к Redis

```bash
sudo systemctl status redis-server
sudo systemctl restart redis-server
```

### FastAPI не запускается на порту 8000

```bash
# Проверить занят ли порт
sudo lsof -i :8000

# Убить процесс если нужно
sudo kill -9 <PID>
```

### Webhook не работает

1. Проверьте что FastAPI запущен: `curl http://localhost:8000/api/indexer/health`
2. Проверьте логи FastAPI: `journalctl -u hypersniper-api -f`
3. Проверьте настройки индексера

